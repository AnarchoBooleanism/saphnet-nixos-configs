# Much of this comes from https://dev.to/marrouchi/the-challenge-about-ssl-in-docker-containers-no-one-talks-about-32gh

x-common:
  TIMEZONE: &timezone "${TZ}"

services:
  nginx:
    image: ghcr.io/anarchobooleanism/saphnet-nginx:latest@sha256:d6c1c705a06e505c4a487e91c25ef5bf06e336a17b21111e32c1fa01fc39191d
    ports:
      - "80:80"
      - "443:443"
    environment:
      TZ: *timezone
    volumes:
      # Main conf file
      - ${NGINX_PROXIES_FILE}:/etc/nginx/proxies.conf:ro
      # Certificate files
      - certbot-conf:/etc/letsencrypt:ro
    networks: # For connecting with other services directly
      - central-network
    restart: unless-stopped
  
  certbot:
    image: ghcr.io/anarchobooleanism/certbot-dns-namecheap:latest@sha256:929c152ae8e7dfbba0daeb23d77758d4ba37c49eb6371d3110e238216ea2c485
    entrypoint: |
      /bin/sh -c 'trap exit TERM; while :; do certbot renew -vv; sleep 12h & wait $${!}; done;'
    environment:
      TZ: *timezone
    volumes:
      - certbot-conf:/etc/letsencrypt
      - ${NAMECHEAP_API_DETAILS_FILE}:/namecheap.ini
    # Renew certificates every 12 hours
    restart: unless-stopped

volumes:
  certbot-conf:
    name: certbot-conf
    external: true

networks:
  central-network:
    name: central-network
    external: true
